#include "variables"
#! /usr/bin/make -f
#
# rules for <:=$PACKAGE:>
#
<:=@COPYRIGHT:>//

tmp := $(shell pwd)/debian/tmp/

SHELL := /bin/bash
INSTDIR := install -m 755 -d
INSTPROG := install -m 755 -s
INSTDATA := install -m 644
INSTSCRIPT := install -m 755

<:# DO NOT include debian/rules :>//
DFILES := debian/README debian/copyright \
debian/config debian/preinst debian/postinst debian/prerm debian/postrm \
debian/install debian/remove \
debian/docbase debian/templates

debian/system.variables: /home/salve/.../Debian/Packages/system.variables
	$(INSTDATA) $< $@

debian/rules: debian/variables

<:# Eperl is simply great: thanks, Ralf! :>//
% :: %.in
	eperl -P -o $@ $<

build: $(DFILES)
	$(checkdir)
	test -e ./configure || autoconf
	./configure
	$(MAKE) MAKEINFO="makeinfo --verbose" \
		TEXI2HTML="texi2html -verbose" \
		info html
	touch build

clean:
	$(checkdir)
	-rm -rf build core $(tmp) debian/files* debian/substvars
	-rm -f	$(DFILES)
	-$(MAKE) distclean

binary: binary-indep binary-arch

binary-arch: checkroot build
	$(checkdir)

binary-indep: checkroot build
	$(checkdir)
	-rm -rf $(tmp)

<:# install package :>//
	$(INSTDIR) $(tmp)/<:=$info:> $(tmp)/<:=$lisp:>
	$(INSTDATA) <:=$SOURCES:> $(tmp)/<:=$lisp:>
	$(INSTDATA) <:=$INFOS:> $(tmp)/<:=$info:>
	gzip -9frv $(tmp)/<:=$info:>

<:# install Debian doc :>//
	$(INSTDIR) $(tmp)/<:=$doc:> $(tmp)/<:=$html:>
	$(INSTDATA) <:=$DOCS:> $(tmp)/<:=$doc:>
	$(INSTDATA) debian/README $(tmp)/<:=$doc:>/README.Debian
	$(INSTDATA) ChangeLog $(tmp)/<:=$doc:>
	$(INSTDATA) debian/changelog $(tmp)/<:=$doc:>/changelog.Debian
	gzip -9frv $(tmp)/<:=$doc:>
	ln -sf ChangeLog.gz $(tmp)/<:=$doc:>/changelog.gz
	$(INSTDATA) debian/copyright $(tmp)/<:=$doc:>
	$(INSTDATA) <:=$HTMLS:> $(tmp)/<:=$html:>
	ln -snf mailcrypt_toc.html $(tmp)/<:=$html:>/index.html

<:# install Debian system files :>//
	$(INSTDIR) $(tmp)/<:=$ecode:>/{install,remove} $(tmp)/<:=$docbase:>
	$(INSTDATA) debian/<:=$PACKAGE:>-init.el $(tmp)/<:=$lisp:>/../
	$(INSTDATA) debian/docbase $(tmp)/<:=$docbase:>/<:=$PACKAGE:>
	$(INSTSCRIPT) debian/install $(tmp)/<:=$ecode:>/install/<:=$PACKAGE:>
	$(INSTSCRIPT) debian/remove $(tmp)/<:=$ecode:>/remove/<:=$PACKAGE:>

<:# install Debian control files :>//
	$(INSTDIR) $(tmp)/<:=$debian:>
	$(INSTDATA) debian/templates $(tmp)/<:=$debian:>
	$(INSTSCRIPT) debian/{config,preinst,postinst,prerm,postrm} $(tmp)/<:=$debian:>

<:# standard stuff :>//
	cd $(tmp) && md5sum \
		$$(find ./ -path './DEBIAN' -prune -o -type f -printf "%P\n") \
		| sort -k 2 -o $(tmp)/<:=$debian:>/md5sums
	dpkg-gencontrol -isp
	chown -R root.root $(tmp)
	chmod -R go=rX $(tmp)
	dpkg --build $(tmp) ..

checkdir = test -f debian/rules

checkroot:
	$(checkdir)
	test root = "$$(whoami)"

source diff:
	@echo >&2 'source and diff are obsolete - use dpkg-source -b'; false

.PHONY: binary binary-arch binary-indep clean checkroot
<:
# local variables:
# mode: makefile
# end:
:>//
