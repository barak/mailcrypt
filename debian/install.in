#include "variables"
#! /bin/bash
#
# <% elisp %> Emacs install script for <:=${PACKAGE}:>
#
<:=@COPYRIGHT:>//

set -e
set -o posix

<:# parse debconf database :>//
source <:=${CONFMODULE}:>
db_version 2.0
db_get <:=${PACKAGE}:>/default || true; _db_default=${RET}

FLAVOR=${1}

INSTALL="install -o root -g root -m 644"
INSTDIR="${INSTALL} -m 755 -d"

do_install () {
    echo >&2 -n "install/<:=${PACKAGE}:>: Setting up for ${FLAVOR}" \
    "(log file: <:=if($_=${lisp})=~s|emacs|\${FLAVOR}|:>/<:=${ELCLOG}:>)... "
    cd <:=${lisp}:>; umask 0022;
    <:# ensure that "configure" is up-to-date WRT "configure.in" :>//
    touch --reference configure --date "-1 second" configure.in
    ${INSTDIR} <:=if($_=${lisp})=~s|emacs|\${FLAVOR}|:>
    EMACS=${FLAVOR} ./configure \
	--prefix=<:$_=${usr}; s|/+|/|g; print:> \
	>> <:=if($_=${lisp})=~s|emacs|\${FLAVOR}|:>/<:=${ELCLOG}:> 2>&1
    make INSTALL="${INSTALL}" MKINSTALLDIRS="${INSTDIR}" \
	lispdir=<:$_=${lisp}; s|emacs|\${FLAVOR}|; s|/+|/|g; print:> \
	install-lisp \
	>> <:=if($_=${lisp})=~s|emacs|\${FLAVOR}|:>/<:=${ELCLOG}:> 2>&1
    make distclean \
	>> <:=if($_=${lisp})=~s|emacs|\${FLAVOR}|:>/<:=${ELCLOG}:> 2>&1
    find <:=if($_=${lisp})=~s|emacs|\${FLAVOR}|:> -type f -name \*.el \
	-print0 | xargs --null rm -f ,dummy, \
	>> <:=if($_=${lisp})=~s|emacs|\${FLAVOR}|:>/<:=${ELCLOG}:> 2>&1
    gzip -9fq <:=if($_=${lisp})=~s|emacs|\${FLAVOR}|:>/<:=${ELCLOG}:>
    cat ><:=if($_="${sstartd}/${EPRIORITY}${PACKAGE}.el")
	   =~s|emacs|\${FLAVOR}|:> <<EOF
;;; This file is automatically generated.

(if (fboundp 'debian-pkg-add-load-path-item)
    (debian-pkg-add-load-path-item "<:=if($_=${lisp})
				       =~s|emacs|\${FLAVOR}|:>")
  (add-to-list 'load-path "<:=if($_=${lisp})
		      =~s|emacs|${FLAVOR}|:>" 'append))
(add-to-list 'load-path "<:=${lisp}:>" 'append)
EOF
    if [ "${_db_default}" = "true" ]; then
	cat >><:=if($_="${sstartd}/${EPRIORITY}${PACKAGE}.el")
		      =~s|emacs|\${FLAVOR}|:> <<EOF

(require 'mailcrypt-init)
EOF
    fi
    echo >&2 "done."
    return 0
}

case "${FLAVOR}" in
    emacs) :;;
    emacs2[123]|emacs-snapshot) do_install ${FLAVOR};;
    *) echo >&2 "install/<:=${PACKAGE}:>:" \
	"Ignoring emacsen flavor: \"${FLAVOR}\"."
esac

exit 0
<:
# arch-tag: 8f5878f2-a4b0-44a9-bb22-92f48baf39b3
#
# local variables:
# mode: shell-script
# coding: utf-8
# ispell-local-dictionary: "american"
# ispell-check-comments: exclusive
# end:
#
# LocalWords:  debconf
:>//
