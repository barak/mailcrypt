#include "variables"
#! /bin/bash -e
#
# <% elisp %> emacs install script for <:=${PACKAGE}:>
#
<:=@COPYRIGHT:>//

set -o posix

<:# parse debconf database :>//
source <:=${CONFMODULE}:>
db_version 2.0
db_get <:=${PACKAGE}:>/default || true; _db_default=${RET}

FLAVOR=${1}

INSTALL="install -o root -g root"
INSTDIR="${INSTALL} -m 755 -d"

do_install () {
    echo >&2 -n "install/<:=${PACKAGE}:>: Setting up for ${FLAVOR}... "
    cd <:=${lisp}:>; umask 0022;
    ${INSTDIR} <:=if($_=${lisp})=~s|emacs|\${FLAVOR}|:>
    EMACS=${FLAVOR} ./configure \
	--prefix=<:$_=${usr}; s|/+|/|g; print:> \
	>> <:=if($_=${lisp})=~s|emacs|\${FLAVOR}|:>/<:=${ELCLOG}:> 2>&1
    make INSTALL="${INSTALL}" MKINSTALLDIRS="${INSTDIR}" \
	lispdir=<:$_=${lisp}; s|emacs|\${FLAVOR}|; s|/+|/|g; print:> \
	install-lisp \
	>> <:=if($_=${lisp})=~s|emacs|\${FLAVOR}|:>/<:=${ELCLOG}:> 2>&1
    make distclean \
	>> <:=if($_=${lisp})=~s|emacs|\${FLAVOR}|:>/<:=${ELCLOG}:> 2>&1
    find <:=if($_=${lisp})=~s|emacs|\${FLAVOR}|:> -type f -name \*.el \
	-print0 | xargs --null rm -f ,dummy, \
	>> <:=if($_=${lisp})=~s|emacs|\${FLAVOR}|:>/<:=${ELCLOG}:> 2>&1
    gzip -9fq <:=if($_=${lisp})=~s|emacs|\${FLAVOR}|:>/<:=${ELCLOG}:>
    echo -e ><:=if($_="${sstartd}/${EPRIORITY}${PACKAGE}.el")
	       =~s|emacs|\${FLAVOR}|:> \
	";;; This file is automatically generated.\n"
    echo -e >><:=if($_="${sstartd}/${EPRIORITY}${PACKAGE}.el")
	     =~s|emacs|\${FLAVOR}|:> \
	"(if (fboundp 'debian-pkg-add-load-path-item)\n" \
	"   (progn (debian-pkg-add-load-path-item \"<:=if($_=${lisp})
		 =~s|emacs|\${FLAVOR}|:>\")\n" \
	"          (debian-pkg-add-load-path-item \"<:=${lisp}:>\"))\n" \
	" (progn (add-to-list 'load-path \"<:=if($_=${lisp})
		 =~s|emacs|\${FLAVOR}|:>\" 'append)\n" \
	"        (add-to-list 'load-path \"<:=${lisp}:>\" 'append)))"
    if [ "${_db_default}" = "true" ]; then
	echo -e >><:=if($_="${sstartd}/${EPRIORITY}${PACKAGE}.el")
		    =~s|emacs|\${FLAVOR}|:> \
	"\n(require 'mailcrypt-init)"
    fi
    echo >&2 "done."
    return 0
}

case "${FLAVOR}" in
    (emacs) : ;;
    (emacs21|emacs-snapshot)
    do_install ${FLAVOR}
    ;;
    (*) echo >&2 "install/<:=${PACKAGE}:>:" \
	"Ignoring emacsen flavor: \"${FLAVOR}\""
    ;;
esac

exit 0
<:
# local variables:
# mode: shell-script
# ispell-local-dictionary: "american"
# ispell-check-comments: exclusive
# end:
# arch-tag: 8f5878f2-a4b0-44a9-bb22-92f48baf39b3
:>//
